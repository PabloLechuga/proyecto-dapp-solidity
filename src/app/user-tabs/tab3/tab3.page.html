<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      Mi Perfil
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refreshData()" [disabled]="isLoading">
        <ion-icon slot="icon-only" name="refresh"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Mi Perfil</ion-title>
    </ion-toolbar>
  </ion-header>

  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando información...</p>
  </div>

  <ion-card *ngIf="message" [color]="messageColor">
    <ion-card-content>
      {{ message }}
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="!isLoading && walletAddress">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="person-circle" style="font-size: 2rem; vertical-align: middle;"></ion-icon>
        {{ profile.role }}
      </ion-card-title>
      <ion-card-subtitle>Perfil de {{ profile.role }}</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <ion-list>
        <ion-item>
          <ion-icon name="wallet" slot="start"></ion-icon>
          <ion-label>
            <h3>Dirección Wallet</h3>
            <p>{{ formatAddress(profile.walletAddress) }}</p>
          </ion-label>
          <ion-button fill="clear" slot="end" (click)="copyAddress()">
            <ion-icon slot="icon-only" name="copy"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item>
          <ion-icon name="cash" slot="start" color="success"></ion-icon>
          <ion-label>
            <h3>Balance</h3>
            <p>{{ profile.balance }} ETH</p>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-icon name="ticket" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Entradas Compradas</h3>
            <p>{{ profile.totalTicketsPurchased }} tickets adquiridos</p>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-icon name="albums" slot="start" color="secondary"></ion-icon>
          <ion-label>
            <h3>En tu Cartera</h3>
            <p>{{ myTickets.length }} entradas activas</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="!isLoading && myTickets.length > 0">
    <ion-card-header>
      <ion-card-title>Mis Entradas</ion-card-title>
      <ion-card-subtitle>{{ myTickets.length }} entradas en tu cartera</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <ion-list>
        <ion-card *ngFor="let ticket of myTickets" style="margin-bottom: 16px;">
          <ion-card-content>
            <ion-item lines="none">
              <ion-icon name="musical-notes" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h2><strong>{{ ticket.name }}</strong></h2>
                <p>Token ID: #{{ ticket.tokenId }}</p>
                <ion-note>Artista: {{ ticket.artistName }}</ion-note>
              </ion-label>
              <ion-badge slot="end" color="success">
                Válida
              </ion-badge>
            </ion-item>

            <ion-button 
              expand="block" 
              color="warning" 
              (click)="openResaleModal(ticket)"
              style="margin-top: 12px;">
              <ion-icon name="repeat" slot="start"></ion-icon>
              Revender esta Entrada
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-modal [isOpen]="!!selectedTicketForResale" (didDismiss)="closeResaleModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Revender Entrada</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeResaleModal()">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content>
        <ion-card *ngIf="selectedTicketForResale">
          <ion-card-header>
            <ion-card-title>{{ selectedTicketForResale.name }}</ion-card-title>
            <ion-card-subtitle>Token ID: #{{ selectedTicketForResale.tokenId }}</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <ion-list>
              <ion-item>
                <ion-label>
                  <h3>Artista</h3>
                  <p>{{ selectedTicketForResale.artistName }}</p>
                </ion-label>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">
                  <h2>Precio de Reventa (ETH)</h2>
                </ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="resalePrice"
                  placeholder="0.05"
                  step="0.01"
                  min="0"
                  style="margin-top: 10px;">
                </ion-input>
              </ion-item>
            </ion-list>

            <ion-button 
              expand="block" 
              color="success" 
              (click)="confirmResale()"
              [disabled]="isReselling || resalePrice <= 0"
              style="margin-top: 20px;">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              <span *ngIf="!isReselling">Publicar en Marketplace Secundario</span>
              <span *ngIf="isReselling">Publicando...</span>
            </ion-button>

            <ion-note style="display: block; text-align: center; margin-top: 10px; opacity: 0.7;">
              <ion-icon name="information-circle"></ion-icon>
              Esta entrada se publicará en el marketplace secundario
            </ion-note>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-card *ngIf="!isLoading && myTickets.length === 0 && walletAddress">
    <ion-card-content class="empty-state">
      <ion-icon name="ticket-outline" style="font-size: 4rem; opacity: 0.3;"></ion-icon>
      <h3>No tienes entradas</h3>
      <p>Las entradas que compres aparecerán aquí</p>
      <ion-button routerLink="/user-tabs/tab2" expand="block">
        Ver Marketplace
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="!isLoading && !walletAddress">
    <ion-card-content class="empty-state">
      <ion-icon name="wallet-outline" style="font-size: 4rem; opacity: 0.3;"></ion-icon>
      <h3>Wallet no conectada</h3>
      <p>Por favor conecta tu wallet para ver tu perfil</p>
      <ion-button routerLink="/login-tabs/tab1" expand="block">
        Ir a Login
      </ion-button>
    </ion-card-content>
  </ion-card>

</ion-content>
